version: "3.7"
services:
  transaction:
    build:
      context: "./transaction/"
    container_name: yape-transaction
    depends_on: [kafka, postgres, zookeeper]
    image: transaction
    ports:
      - 3000:3000
    environment:
      - PORT=3000
      - API_PREFIX=TD_MY_API
      - CONTEXT=v1
      - ORIGINS=http://localhost:3000,http://localhost:8080
      - ALLOWED_HEADERS=Content-Type,Authorization,Set-Cookie,Access-Control-Allow-Origin,Cache-Control,Pragma
      - ALLOWED_METHODS=GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS
      - CORS_ENABLED=true
      - CORS_CREDENTIALS=false
      - TYPEORM_HOST=postgres
      - TYPEORM_PORT=5432
      - TYPEORM_USERNAME=yape
      - TYPEORM_PASSWORD=yapechallenge
      - TYPEORM_DATABASE=yape
      - GRAPHQL_PLAYGROUND=true
      - GRAPHQP_SCHEMA_DIR=./src/graphql/schema.gql
      - KAFKA_CLIENT_ID=TRANSACTION_SERVICE
      - KAFKA_BROKER=kafka:29092
      - KAFKA_LOG_LEVEL=0
  antifraude:
    build:
      context: "./antifraude/"
    container_name: yape-antifraude
    depends_on: [kafka, postgres, zookeeper]
    image: antifraude
    environment:
      - KAFKA_COMSUMER_GROUP_ID=ANTIFRAUDE_SERVICE
      - KAFKA_BROKER=kafka:29092
      - KAFKA_LOG_LEVEL=0
  postgres:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=yape
      - POSTGRES_PASSWORD=yapechallenge
      - POSTGRES_DATABASE=challenge
  zookeeper:
    image: confluentinc/cp-zookeeper:5.5.3
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
  kafka:
    image: confluentinc/cp-enterprise-kafka:5.5.3
    depends_on: [zookeeper]
    environment:
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_BROKER_ID: 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_JMX_PORT: 9991
    ports:
      - 9092:9092
